# Model

Basic data preprocessing steps:

1. Find and remove outliers using Grubbs.
2. Standardize by Z score.
3. Check for normality.
4. Transform and recheck normality. We decided not to use transformed data as it did not correct the few conditions with multiple skewed groups.


## Methods

A mixed linear effects model was estimated for each aim.
Fixed effects for Aim 1 were condition (wildtype-rest (ref), wildtype-exercise, knockout-rest, knockout-exercise), and metabolite.
Fixed effects for Aim 2 were condition (wildtype-exercise (ref), knockout-exercise, knockout-C7, knockout-C8), and metabolite.
All 2-way interactions between fixed effects were included in the models.
Animal ID was the random effect.
A general correlation structure was assumed.
Estimates for the contrasts comparing each combination of condition and metabolite are presented.
P-values were adjusted to control the false discovery rate, the expected proportion of false discoveries amongst the rejected hypotheses.
The data was analyzed using `r R.Version()$version.string` and the `nlme` package version `r packageVersion("nlme")`.


## References

Benjamini, Y., and Hochberg, Y.
(1995).
Controlling the false discovery rate: a practical and powerful approach to multiple testing.
*Journal of the Royal Statistical Society Series B* 57, 289â€“300.

```{r}
citation()
citation("nlme")
```


## Aim 1

**WT-rest (ref), WT-exercise, KO-rest, KO-exercise**

Estimate model.
Specify the correlation structure using `cs`.
Use `corSymm`, *general correlation matrix, with no additional structure*.

```{r}
estimateModel <- function (data) {
  require(magrittr)
  require(nlme)
  fixed <- formula(z_value ~
                     condition +
                     metabolite +
                     condition * metabolite)
  random <- formula(~ 1 | id)
  ctrl <- lmeControl(opt = "optim",
                     maxIter = 500, msMaxIter = 500,
                     tolerance = 1e-6, niterEM = 25, msMaxEval = 200, msTol = 1e-7)
  cs <-
    corSymm(form = random, fixed = FALSE) %>%
    Initialize(data = data)
  Dim(cs)
  lme(fixed,
      data = data,
      random = random,
      correlation = cs,
      control = ctrl)
}
```

### Amino Acids and TCA Cycle intermediates (Neg)

```{r, lmeDiagnosticAim1a}
M <- estimateModel(data = D1a)
M %>% plot()
M %>% ranef() %>% plot()
M %>% anova() %>% kable()
M %>% tidy(effects = "fixed") %>% kable()
M %>% tidy(effects = "fixed") %>% write.csv(file = "../data/processed/lmeFixedCoefAim1a.csv", row.names = FALSE)
M1a <- M
```


## Save

Save `lme` objects for interactive work.

```{r}
save(M1a, file = "../data/processed/lmeObjects.RData")
```
