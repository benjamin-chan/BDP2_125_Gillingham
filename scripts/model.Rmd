# Model

Basic data preprocessing steps:

1. Find and remove outliers using Grubbs.
2. Standardize by Z score.
3. Check for normality.
4. Transform and recheck normality. We decided not to use transformed data as it did not correct the few conditions with multiple skewed groups.


## Methods

A mixed linear effects model was estimated for each aim.
Fixed effects for Aim 1 were condition (wildtype-rest (ref), wildtype-exercise, knockout-rest, knockout-exercise), and metabolite.
Fixed effects for Aim 2 were condition (wildtype-exercise (ref), knockout-exercise, knockout-C7, knockout-C8), and metabolite.
All 2-way interactions between fixed effects were included in the models.
Animal ID was the random effect.
A general correlation structure was assumed.
Estimates for the contrasts comparing each combination of condition and metabolite are presented.
P-values were adjusted to control the false discovery rate, the expected proportion of false discoveries amongst the rejected hypotheses.
The data was analyzed using `r R.Version()$version.string` and the `nlme` package version `r packageVersion("nlme")`.

Estimate model.
Specify the correlation structure using `cs`.
Use `corCompSymm`, *compound symmetry structure corresponding to a constant correlation*.

**References**

Benjamini, Y., and Hochberg, Y.
(1995).
Controlling the false discovery rate: a practical and powerful approach to multiple testing.
*Journal of the Royal Statistical Society Series B* 57, 289â€“300.

```{r}
citation()
citation("nlme")
```


## Aim 1

* WT-rest (ref)
* WT-exercise
* KO-rest
* KO-exercise

### Aim 1-a: Amino Acids and TCA Cycle intermediates (Neg)

```{r, lmeDiagnosticAim1a}
t0 <- Sys.time()
M <- estimateModel(data = D1a)
Sys.time() - t0
M %>% plot()
M %>% ranef() %>% plot()
M %>% anova() %>% kable()
M %>% tidy(effects = "fixed") %>% kable()
M %>% tidy(effects = "fixed") %>% write.csv(file = "data/processed/lmeFixedCoefAim1a.csv", row.names = FALSE)
M1a <- M
```

### Aim 1-b: Acylcarnitines

```{r, lmeDiagnosticAim1b}
t0 <- Sys.time()
M <- estimateModel(data = D1b)
Sys.time() - t0
M %>% plot()
M %>% ranef() %>% plot()
M %>% anova() %>% kable()
M %>% tidy(effects = "fixed") %>% kable()
M %>% tidy(effects = "fixed") %>% write.csv(file = "data/processed/lmeFixedCoefAim1b.csv", row.names = FALSE)
M1b <- M
```


## Aim 2

* WT-exer (ref)
* KO-C7
* KO-C8
* KO-exer

### Aim 2-a: Amino Acids and TCA Cycle intermediates (Neg)

```{r, lmeDiagnosticAim2a}
t0 <- Sys.time()
M <- estimateModel(data = D2a)
Sys.time() - t0
M %>% plot()
M %>% ranef() %>% plot()
M %>% anova() %>% kable()
M %>% tidy(effects = "fixed") %>% kable()
M %>% tidy(effects = "fixed") %>% write.csv(file = "data/processed/lmeFixedCoefAim2a.csv", row.names = FALSE)
M2a <- M
```

### Aim 2-b: Acylcarnitines

```{r, lmeDiagnosticAim2b}
t0 <- Sys.time()
M <- estimateModel(data = D2b)
Sys.time() - t0
M %>% plot()
M %>% ranef() %>% plot()
M %>% anova() %>% kable()
M %>% tidy(effects = "fixed") %>% kable()
M %>% tidy(effects = "fixed") %>% write.csv(file = "data/processed/lmeFixedCoefAim2b.csv", row.names = FALSE)
M2b <- M
```


## Save

Save `lme` objects for interactive work.

```{r}
save(M1a, M1b, M2a, M2b, file = "data/processed/lmeObjects.RData")
```
